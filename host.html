<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿå·¥å¤§åŠ‡å ´ - èª°æ˜¯æ€ªå’–ç‹</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #171615; color: #fff; text-align: center; font-family: sans-serif; }
        .control-panel { background: #28276d; padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 600px; }
        .q-display { background: #ebcf9f; padding: 15px; border-radius: 10px; margin: 20px 0; min-height: 100px; color: #333; }
        .btn-main { background: #2da551; color: white; border: none; padding: 15px 30px; font-size: 1.5rem; border-radius: 10px; cursor: pointer; margin: 10px; }
        .btn-sub { background: #6d7175; color: white; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 8px; cursor: pointer; }
        /* çµ±è¨ˆæŒ‰éˆ•æ¨£å¼ */
        .btn-calc { background: #ffc107; color: black; border: none; padding: 15px 30px; font-size: 1.5rem; border-radius: 10px; cursor: pointer; margin: 10px; font-weight: bold; display: none; }
        #winner-box { background: #df2b2b; color: #f6e6c9; padding: 20px; border-radius: 15px; display: none; margin-top: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <h1>ç”Ÿå·¥å¤§åŠ‡å ´ - èª°æ˜¯æ€ªå’–ç‹</h1>

    <div class="control-panel">
        <div class="q-display">
            <h3 id="current-round" style="color: #4a4b94;"></h3>
            <h1 id="current-q"></h1>
            <p id="options-hint" style="color: #423d3d;"></p>
        </div>

        <div id="winner-box">
            <h2 id="result-title"> å”¯ä¸€ä¸”ç¨ç‰¹çš„é€™ç¾¤æœ‹å‹å€‘ </h2>
            <h1 id="winner-name">---</h1>
        </div>

        <hr style="border: 0.5px solid #444; margin: 20px 0;">
        
        <button onclick="triggerWinner()" id="calc-btn" class="btn-calc">ğŸ“Š çµ±è¨ˆèª°æ˜¯æ€ªå’–</button>
        <br>
        <button onclick="nextStep()" id="next-btn" class="btn-main">é–‹å§‹éŠæˆ² â–¶ï¸</button>
        <br>
        <button onclick="prevStep()" class="btn-sub">â¬…ï¸ å›ä¸Šä¸€é¡Œ</button>

        <br><br>
        <button onclick="resetGame()" style="background: #444; color: #888; border: none; padding: 5px 10px; font-size: 0.7rem; cursor: pointer; border-radius: 5px;">
            å±éšªå€åŸŸï¼šé‡ç½®æ•´å€‹éŠæˆ²æ•¸æ“š
        </button>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyB9utfozRJXaMj07hOCMrEKB_s1wKVfbFw",
            authDomain: "bse-weirdoking.firebaseapp.com",
            projectId: "bse-weirdoking",
            storageBucket: "bse-weirdoking.firebasestorage.app",
            messagingSenderId: "154551508057",
            appId: "1:154551508057:web:47b1be7e7d76743788a548",
            measurementId: "G-WL3E8V5H94",
            databaseURL: "https://bse-weirdoking-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // é‡ç½®éŠæˆ²å‡½å¼
        window.resetGame = async () => {
            if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æŠ•ç¥¨ç´€éŒ„ä¸¦å›åˆ°å ±åéšæ®µå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
                try {
                    // 1. å›åˆ°ç¬¬ 0 é¡Œ
                    await set(ref(db, 'gameState/currentStep'), 0);
                    // 2. åˆªé™¤æ‰€æœ‰æŠ•ç¥¨ç´€éŒ„
                    await set(ref(db, 'votes'), null); 
                    
                    alert("éŠæˆ²å·²é‡ç½®ï¼ç¾åœ¨å¯ä»¥é‡æ–°é–‹å§‹äº†ã€‚");
                    location.reload(); // é‡æ–°æ•´ç†é é¢ç¢ºä¿è®Šæ•¸ä¹¾æ·¨
                } catch (error) {
                    console.error("é‡ç½®å¤±æ•—ï¼š", error);
                    alert("é‡ç½®å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
                }
            }
        };

        let step = 0;

        const questions = [
            { r: "æº–å‚™ä¸­...", q: "è«‹è¼¸å…¥åå­—", a: "", b: "" },
            { r: "ç¬¬ä¸€è¼ª (1/8)", q: "åƒä¸åƒé¦™èœï¼Ÿ", a: "åƒ", b: "ä¸åƒ" },
            { r: "ç¬¬ä¸€è¼ª (2/8)", q: "æ»·è‚‰é£¯æ‹Œä¸æ‹Œï¼Ÿ", a: "æ‹Œ", b: "ä¸æ‹Œ" },
            { r: "ç¬¬ä¸€è¼ª (3/8)", q: "å’–å“©æ‹Œä¸æ‹Œï¼Ÿ", a: "æ‹Œ", b: "ä¸æ‹Œ" },
            { r: "ç¬¬ä¸€è¼ª (4/8)", q: "ç«é‹èŠ‹é ­åŠ ä¸åŠ ï¼Ÿ", a: "åŠ ", b: "ä¸åŠ " },
            { r: "ç¬¬ä¸€è¼ª (5/8)", q: "å…¨ç³–æ‰‹æ–å–ä¸å–ï¼Ÿ", a: "å–", b: "ä¸å–" },
            { r: "ç¬¬ä¸€è¼ª (6/8)", q: "å¥¶èŒ¶ç¨®é¡ï¼Ÿ", a: "å¥¶ç²¾å¥¶èŒ¶", b: "é®®å¥¶èŒ¶" },
            { r: "ç¬¬ä¸€è¼ª (7/8)", q: "åœ°ç„é£Ÿæï¼Ÿ", a: "ä¸‰è‰²è±†", b: "è¢å…‰å’–å“©" },
            { r: "ç¬¬ä¸€è¼ª (8/8)", q: "çµå¥‡ç«é‹ï¼Ÿ", a: "è¶Šå—é´¨ä»”è›‹", b: "è±¬è…¦ç«é‹" },
            { r: "ä¼‘æ¯ä¸€ä¸‹æ²’æœ‰é€²å»£å‘Š", q: "èª°æ˜¯ç›®å‰çš„æ€ªå’–ï¼Ÿ", a: "", b: "" }, // Index 9
            { r: "ç¬¬äºŒè¼ª", q: "å“ªç¨®æ¯”è¼ƒå¥½å‘¢ï¼Ÿ", a: "å®‰éœè™•å¿…æ”¾å¤§å±", b: "ä¸€è¼©å­æ‹¿åŸºæœ¬å·¥è³‡" },
            { r: "ç¬¬äºŒè¼ª", q: "å¤–å‹èˆ‡æ°£å‘³ï¼Ÿ", a: "è¶…å¥½çœ‹ä½†æ¥µè‡­", b: "é†œä½†è‡ªå¸¶é¦™å‘³" },
            { r: "ç¬¬äºŒè¼ª", q: "äººç”ŸèƒŒæ™¯éŸ³ï¼Ÿ", a: "å°·å°¬æ™‚æœ‰æ‚²æƒ…é‹¼ç´", b: "å¤±æ•—æ™‚æœ‰ç½é ­ç¬‘è²" },
            { r: "ç¬¬äºŒè¼ª", q: "æˆ¿é–“ç¼ºé™·ï¼Ÿ", a: "é–€é—œä¸èµ·ä¾†", b: "çª—æˆ¶å¡ä½åŠé–‹" },
            { r: "ç¬¬äºŒè¼ª", q: "ç°¡å ±é…·åˆ‘ï¼Ÿ", a: "åœ–ç‰‡æª”ä¸”é…è‰²é›£çœ‹", b: "ä¸çµ¦èª²å¾Œæª”æ¡ˆ" },
            { r: "ç¬¬äºŒè¼ª", q: "é­”é¬¼èª²ç¨‹ï¼Ÿ", a: "PUAç’°å¢ƒå·¥ç¨‹", b: "ç•¶æ‰ä¸€åŠçš„æµé«”åŠ›å­¸" },
            { r: "ç¬¬äºŒè¼ª", q: "ä¸Šèª²åœ°ç„ï¼Ÿ", a: "åè¶…è‡­åŒå­¸æ—é‚Š", b: "æ•™æˆæ¯å ‚å¿…æŠ½å•" },
            { r: "ç¬¬äºŒè¼ª", q: "é«˜æº«æŒ‘æˆ°ï¼Ÿ", a: "é£²æ°´æ©Ÿåªæœ‰43åº¦æ°´", b: "å†·æ°£å£æ‰ä¸Šä¸‰å°æ™‚èª²" },
            { r: "æœ€çµ‚çµç®—", q: "ç©¶æ¥µæ€ªå’–ç‹ï¼Ÿï¼", a: "", b: "" } // Index 18
        ];

        /* æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—èª°é¸äº†æœ€å¤šã€Œå°‘æ•¸æ´¾ã€
        async function getWinner(untilStep) {
            const snapshot = await get(ref(db, 'votes'));
            if (!snapshot.exists()) return "ç„¡æ•¸æ“š";
            const allVotes = snapshot.val();
            let userMinorityCount = {};

            for (let i = 1; i <= untilStep; i++) {
                if (!allVotes[i]) continue;
                let votes = allVotes[i];
                let countA = 0, countB = 0;
                for (let name in votes) {
                    if (votes[name].choice === 'A') countA++; else countB++;
                }

                let minorityChoice = countA < countB ? 'A' : (countB < countA ? 'B' : null);
                if (minorityChoice) {
                    for (let name in votes) {
                        if (votes[name].choice === minorityChoice) {
                            userMinorityCount[name] = (userMinorityCount[name] || 0) + 1;
                        }
                    }
                }
            }
            if (Object.keys(userMinorityCount).length === 0) return "å¤§å®¶éƒ½å¾ˆæ­£å¸¸";
            let winner = Object.keys(userMinorityCount).reduce((a, b) => userMinorityCount[a] > userMinorityCount[b] ? a : b);
            return `${winner} (é¸äº† ${userMinorityCount[winner]} æ¬¡å°‘æ•¸é¸é …)`;
        }

        // ç•¶æŒ‰ä¸‹ã€Œçµ±è¨ˆæ€ªå’–ã€æŒ‰éˆ•æ™‚è§¸ç™¼
        window.triggerWinner = async () => {
            const winnerBox = document.getElementById('winner-box');
            const winnerName = document.getElementById('winner-name');
            winnerBox.style.display = "block";
            winnerName.innerText = "è¨ˆç®—ä¸­...";
            
            let result = "";
            if (step === 9) result = await getWinner(8);
            if (step === 18) result = await getWinner(17);
            
            winnerName.innerText = result;
        };*/

        // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—æ€ªå’–ä¸¦æŠ“å–å…¶é¸æ“‡ç´€éŒ„
        async function getWinner(untilStep) {
            const snapshot = await get(ref(db, 'votes'));
            if (!snapshot.exists()) return { name: "ç„¡æ•¸æ“š", history: "" };
    
            const allVotes = snapshot.val();
            let userMinorityCount = {};
        
            // 1. å…ˆç®—å‡ºèª°æ˜¯æ€ªå’–
            for (let i = 1; i <= untilStep; i++) {
                if (!allVotes[i]) continue;
                let votes = allVotes[i];
                let countA = 0, countB = 0;
                for (let name in votes) {
                    if (votes[name].choice === 'A') countA++; else countB++;
                }
                let minorityChoice = countA < countB ? 'A' : (countB < countA ? 'B' : null);
                if (minorityChoice) {
                    for (let name in votes) {
                        if (votes[name].choice === minorityChoice) {
                            userMinorityCount[name] = (userMinorityCount[name] || 0) + 1;
                        }
                    }
                }
            }
        
            if (Object.keys(userMinorityCount).length === 0) return { name: "å¤§å®¶éƒ½å¾ˆæ­£å¸¸", history: "" };
        
            // æ‰¾å‡ºæœ€é«˜åˆ†è€…
            let winner = Object.keys(userMinorityCount).reduce((a, b) => userMinorityCount[a] > userMinorityCount[b] ? a : b);
                
            // 2. æŠ“å–é€™ä½è´å®¶çš„æ­·å²é¸æ“‡ç´€éŒ„
            let historyHtml = "<div style='font-size: 1rem; text-align: left; margin-top: 15px; border-top: 1px dashed #333; padding-top: 10px;'>";
            historyHtml += "<b>ä»–çš„å¥‡è‘©é¸æ“‡ï¼š</b><br>";
            
            for (let i = 1; i <= untilStep; i++) {
                if (allVotes[i] && allVotes[i][winner]) {
                    let choice = allVotes[i][winner].choice;
                    // æ ¹æ“šç´¢å¼•æ‰¾å‡ºè©²é¡Œç›®çš„é¸é …æ–‡å­—
                    let choiceText = choice === 'A' ? questions[i].a : questions[i].b;
                    historyHtml += `ç¬¬${i}é¡Œï¼š${choice} (${choiceText})<br>`;
                }
            }
            historyHtml += "</div>";
        
            return { 
                name: `${winner} (å…±é¸äº† ${userMinorityCount[winner]} æ¬¡å°‘æ•¸é¸é …)`, 
                history: historyHtml 
            };
        }

// ä¿®æ”¹æŒ‰éˆ•è§¸ç™¼å‡½å¼
window.triggerWinner = async () => {
    const winnerBox = document.getElementById('winner-box');
    const winnerName = document.getElementById('winner-name');
    winnerBox.style.display = "block";
    winnerName.innerHTML = "è¨ˆç®—ä¸­..."; // æ”¹ç”¨ innerHTML å› ç‚ºè¦å¡æ¨™ç±¤
    
    let resultObj = { name: "", history: "" };
    if (step === 9) resultObj = await getWinner(8);
    if (step === 18) resultObj = await getWinner(17);
    
    // é¡¯ç¤ºåå­— + æ­·å²ç´€éŒ„
    winnerName.innerHTML = `<span style="font-size: 1.8rem;">${resultObj.name}</span>${resultObj.history}`;
};


        window.nextStep = () => { 
            if (step < questions.length - 1) {
                step++;
                set(ref(db, 'gameState/currentStep'), step);
            }
        };
        
        window.prevStep = () => { 
            if (step > 0) {
                step--;
                set(ref(db, 'gameState/currentStep'), step);
            }
        };

        onValue(ref(db, 'gameState/currentStep'), (snap) => {
            step = snap.val() || 0;
            const q = questions[step];
            
            document.getElementById('current-round').innerText = q.r;
            document.getElementById('current-q').innerText = q.q;
            document.getElementById('options-hint').innerText = q.a ? `${q.a}  ${q.b}`   : "";
            
            const nextBtn = document.getElementById('next-btn');
            const calcBtn = document.getElementById('calc-btn');
            const winnerBox = document.getElementById('winner-box');

            // é€²å…¥çµ±è¨ˆé¡Œ (9 æˆ– 18) æ™‚
            if (step === 9 || step === 18) {
                winnerBox.style.display = "none"; // å…ˆéš±è—çµæœï¼Œç­‰æŒ‰æŒ‰éˆ•
                calcBtn.style.display = "inline-block"; // é¡¯ç¤ºçµ±è¨ˆæŒ‰éˆ•
                nextBtn.innerText = (step === 9) ? "é€²å…¥ç¬¬äºŒè¼ª â¡ï¸" : "éŠæˆ²çµæŸ";
            } else {
                winnerBox.style.display = "none";
                calcBtn.style.display = "none";
                nextBtn.innerText = (step === 0) ? "æ­£å¼é–‹å§‹éŠæˆ² â–¶ï¸" : "ä¸‹ä¸€é¡Œ â¡ï¸";
            }
        });
    </script>
</body>
</html>