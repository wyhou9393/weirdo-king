<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿå·¥å¤§åŠ‡å ´ - èª°æ˜¯æ€ªå’–ç‹</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #171615; color: #fff; text-align: center; font-family: sans-serif; }
        .control-panel { background: #28276d; padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 600px; }
        .q-display { background: #ebcf9f; padding: 15px; border-radius: 10px; margin: 20px 0; min-height: 100px; color: #333; }
        .btn-main { background: #df2b2b; color: white; border: none; padding: 15px 30px; font-size: 1.5rem; border-radius: 10px; cursor: pointer; margin: 10px; }
        .btn-sub { background: #6d7175; color: white; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 8px; cursor: pointer; }
        /* çµ±è¨ˆæŒ‰éˆ•æ¨£å¼ */
        .btn-calc { background: #ffc107; color: black; border: none; padding: 15px 30px; font-size: 1.5rem; border-radius: 10px; cursor: pointer; margin: 10px; font-weight: bold; display: none; }
        #winner-box { background: gold; color: black; padding: 20px; border-radius: 15px; display: none; margin-top: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <h1>ç”Ÿå·¥å¤§åŠ‡å ´ - èª°æ˜¯æ€ªå’–ç‹</h1>

    <div class="control-panel">
        <div class="q-display">
            <h3 id="current-round" style="color: #4a4b94;"></h3>
            <h1 id="current-q"></h1>
            <p id="options-hint" style="color: #423d3d;"></p>
        </div>

        <div id="winner-box">
            <h2 id="result-title"> å”¯ä¸€ä¸”ç¨ç‰¹çš„é€™ç¾¤æœ‹å‹å€‘ </h2>
            <h1 id="winner-name">---</h1>
        </div>

        <hr style="border: 0.5px solid #444; margin: 20px 0;">
        
        <button onclick="triggerWinner()" id="calc-btn" class="btn-calc">ğŸ“Š çµ±è¨ˆèª°æ˜¯æ€ªå’–</button>
        <br>
        <button onclick="nextStep()" id="next-btn" class="btn-main">é–‹å§‹éŠæˆ² â–¶ï¸</button>
        <br>
        <button onclick="prevStep()" class="btn-sub">â¬…ï¸ å›ä¸Šä¸€é¡Œ</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyB9utfozRJXaMj07hOCMrEKB_s1wKVfbFw",
            authDomain: "bse-weirdoking.firebaseapp.com",
            projectId: "bse-weirdoking",
            storageBucket: "bse-weirdoking.firebasestorage.app",
            messagingSenderId: "154551508057",
            appId: "1:154551508057:web:47b1be7e7d76743788a548",
            measurementId: "G-WL3E8V5H94",
            databaseURL: "https://bse-weirdoking-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let step = 0;

        const questions = [
            { r: "æº–å‚™ä¸­...", q: "è«‹è¼¸å…¥åå­—", a: "", b: "" },
            { r: "ç¬¬ä¸€è¼ª (1/8)", q: "åƒä¸åƒé¦™èœï¼Ÿ", a: "åƒ", b: "ä¸åƒ" },
            { r: "ç¬¬ä¸€è¼ª (2/8)", q: "æ»·è‚‰é£¯æ‹Œä¸æ‹Œï¼Ÿ", a: "æ‹Œ", b: "ä¸æ‹Œ" },
            { r: "ç¬¬ä¸€è¼ª (3/8)", q: "å’–å“©æ‹Œä¸æ‹Œï¼Ÿ", a: "æ‹Œ", b: "ä¸æ‹Œ" },
            { r: "ç¬¬ä¸€è¼ª (4/8)", q: "ç«é‹èŠ‹é ­åŠ ä¸åŠ ï¼Ÿ", a: "åŠ ", b: "ä¸åŠ " },
            { r: "ç¬¬ä¸€è¼ª (5/8)", q: "å…¨ç³–æ‰‹æ–å–ä¸å–ï¼Ÿ", a: "å–", b: "ä¸å–" },
            { r: "ç¬¬ä¸€è¼ª (6/8)", q: "å¥¶èŒ¶ç¨®é¡ï¼Ÿ", a: "å¥¶ç²¾å¥¶èŒ¶", b: "é®®å¥¶èŒ¶" },
            { r: "ç¬¬ä¸€è¼ª (7/8)", q: "åœ°ç„é£Ÿæï¼Ÿ", a: "ä¸‰è‰²è±†", b: "è¢å…‰å’–å“©" },
            { r: "ç¬¬ä¸€è¼ª (8/8)", q: "çµå¥‡ç«é‹ï¼Ÿ", a: "è¶Šå—é´¨ä»”è›‹", b: "è±¬è…¦ç«é‹" },
            { r: "ä¼‘æ¯ä¸€ä¸‹æ²’æœ‰é€²å»£å‘Š", q: "èª°æ˜¯ç›®å‰çš„æ€ªå’–ï¼Ÿ", a: "", b: "" }, // Index 9
            { r: "ç¬¬äºŒè¼ª (1/8)", q: "å®‰éœè™•å¿…æ”¾å¤§å±\n vs \nä¸€è¼©å­æ‹¿åŸºæœ¬å·¥è³‡", a: "å“ªä¸€å€‹æ¯”è¼ƒå¥½å‘¢...", b: "" },
            { r: "ç¬¬äºŒè¼ª (2/8)", q: "è¶…æ­£/å¸¥ä½†è¶…è‡­\n vs \nçˆ†é†œä½†è‡ªå¸¶é¦™å‘³", a: "å“ªä¸€å€‹æ¯”è¼ƒå¥½å‘¢...", b: "" },
            { r: "ç¬¬äºŒè¼ª (3/8)", q: "å°·å°¬æ™‚åˆ» æ…¢å‹•ä½œ + é‹¼ç´æ‚²æ­Œ \n vs \n å¤±æ•—æ™‚ ç½é ­ç¬‘è²", a: "è‡ªå¸¶BGM", b: "" },
            { r: "ç¬¬äºŒè¼ª (4/8)", q: "æ°¸é é—œä¸ä½çš„é–€\n vs \nå¡ä½çš„åŠé–‹ç»ç’ƒçª—", a: "", b: "" },
            { r: "ç¬¬äºŒè¼ª (5/8)", q: "èª²å ‚ç°¡å ±æ˜¯åœ–ç‰‡æª”+é…è‰²è¶…é›£çœ‹\n vs \næ²’èª²æœ¬+èª²å¾Œä¸çµ¦ä½ ç°¡å ±æª”", a: "", b: "" },
            { r: "ç¬¬äºŒè¼ª (6/8)", q: "ä¸Šèª²æ»¿æ»¿puaçš„ç’°å¢ƒå·¥ç¨‹ \n vs \nç•¶æ‰ä¸€åŠå­¸ç”Ÿçš„æµé«”åŠ›å­¸", a: "", b: "" },
            { r: "ç¬¬äºŒè¼ª (7/8)", q: "åè¶…è‡­åŒå­¸æ—é‚Š \n vs \næ•™æˆæ¯å ‚ä¸€å®šæŠ½å•", a: "", b: "" },
            { r: "ç¬¬äºŒè¼ª (8/8)", q: "åªæœ‰43åº¦å†°æ°´çš„é£²æ°´æ©Ÿ \n vs \nå†·æ°£å£æ‰çš„æ•™å®¤ä¸Šä¸‰å°æ™‚èª²", a: "", b: "" },
            { r: "æœ€çµ‚çµç®—", q: "ç©¶æ¥µæ€ªå’–ç‹ï¼Ÿï¼", a: "", b: "" } // Index 18
        ];

        // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—èª°é¸äº†æœ€å¤šã€Œå°‘æ•¸æ´¾ã€
        async function getWinner(untilStep) {
            const snapshot = await get(ref(db, 'votes'));
            if (!snapshot.exists()) return "ç„¡æ•¸æ“š";
            const allVotes = snapshot.val();
            let userMinorityCount = {};

            for (let i = 1; i <= untilStep; i++) {
                if (!allVotes[i]) continue;
                let votes = allVotes[i];
                let countA = 0, countB = 0;
                for (let name in votes) {
                    if (votes[name].choice === 'A') countA++; else countB++;
                }

                let minorityChoice = countA < countB ? 'A' : (countB < countA ? 'B' : null);
                if (minorityChoice) {
                    for (let name in votes) {
                        if (votes[name].choice === minorityChoice) {
                            userMinorityCount[name] = (userMinorityCount[name] || 0) + 1;
                        }
                    }
                }
            }
            if (Object.keys(userMinorityCount).length === 0) return "å¤§å®¶éƒ½å¾ˆæ­£å¸¸";
            let winner = Object.keys(userMinorityCount).reduce((a, b) => userMinorityCount[a] > userMinorityCount[b] ? a : b);
            return `${winner} (é¸äº† ${userMinorityCount[winner]} æ¬¡å°‘æ•¸é¸é …)`;
        }

        // ç•¶æŒ‰ä¸‹ã€Œçµ±è¨ˆæ€ªå’–ã€æŒ‰éˆ•æ™‚è§¸ç™¼
        window.triggerWinner = async () => {
            const winnerBox = document.getElementById('winner-box');
            const winnerName = document.getElementById('winner-name');
            winnerBox.style.display = "block";
            winnerName.innerText = "è¨ˆç®—ä¸­...";
            
            let result = "";
            if (step === 9) result = await getWinner(8);
            if (step === 18) result = await getWinner(17);
            
            winnerName.innerText = result;
        };

        window.nextStep = () => { 
            if (step < questions.length - 1) {
                step++;
                set(ref(db, 'gameState/currentStep'), step);
            }
        };
        
        window.prevStep = () => { 
            if (step > 0) {
                step--;
                set(ref(db, 'gameState/currentStep'), step);
            }
        };

        onValue(ref(db, 'gameState/currentStep'), (snap) => {
            step = snap.val() || 0;
            const q = questions[step];
            
            document.getElementById('current-round').innerText = q.r;
            document.getElementById('current-q').innerText = q.q;
            document.getElementById('options-hint').innerText = q.a ? `${q.a}  ${q.b}`   : "";
            
            const nextBtn = document.getElementById('next-btn');
            const calcBtn = document.getElementById('calc-btn');
            const winnerBox = document.getElementById('winner-box');

            // é€²å…¥çµ±è¨ˆé¡Œ (9 æˆ– 18) æ™‚
            if (step === 9 || step === 18) {
                winnerBox.style.display = "none"; // å…ˆéš±è—çµæœï¼Œç­‰æŒ‰æŒ‰éˆ•
                calcBtn.style.display = "inline-block"; // é¡¯ç¤ºçµ±è¨ˆæŒ‰éˆ•
                nextBtn.innerText = (step === 9) ? "é€²å…¥ç¬¬äºŒè¼ª â¡ï¸" : "éŠæˆ²çµæŸ";
            } else {
                winnerBox.style.display = "none";
                calcBtn.style.display = "none";
                nextBtn.innerText = (step === 0) ? "æ­£å¼é–‹å§‹éŠæˆ² â–¶ï¸" : "ä¸‹ä¸€é¡Œ â¡ï¸";
            }
        });
    </script>
</body>
</html>