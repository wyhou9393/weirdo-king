<!DOCTYPE html>
<html>
  <div id="host-control-panel">
    <h1 id="step-display">等待玩家加入...</h1>
    <button onclick="nextStep()" id="start-btn" style="background: #28a745; font-size: 2rem;">開始第一題</button>
    <button onclick="prevStep()">回上一題</button>
</div>
<head>
    <meta charset="UTF-8">
    <title>晚會大冒險 - 主持人</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>控制台</h1>
    <h2 id="current-q">當前題目</h2>
    <button onclick="prevStep()">上一題</button>
    <button onclick="nextStep()">下一題</button>
    <hr>
    <button onclick="calculateWinner()" style="background: #ff4757;">公布邊緣王 (得票最少者)</button>
    <div id="result-display"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { 
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            
              apiKey: "AIzaSyB9utfozRJXaMj07hOCMrEKB_s1wKVfbFw",
              authDomain: "bse-weirdoking.firebaseapp.com",
              projectId: "bse-weirdoking",
              storageBucket: "bse-weirdoking.firebasestorage.app",
              messagingSenderId: "154551508057",
              appId: "1:154551508057:web:47b1be7e7d76743788a548",
              measurementId: "G-WL3E8V5H94",
              databaseURL: "https://bse-weirdoking-default-rtdb.firebaseio.com"
            
         };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let step = 0;

        window.nextStep = () => { step++; set(ref(db, 'gameState/currentStep'), step); };
        window.prevStep = () => { if(step > 0) step--; set(ref(db, 'gameState/currentStep'), step); };

        onValue(ref(db, 'gameState/currentStep'), (snap) => {
            step = snap.val() || 0;
           const display = document.getElementById('step-display');
           const btn = document.getElementById('start-btn');
    
           if (step === 0) {
               display.innerText = "現在是：報名階段";
               btn.innerText = "正式開始遊戲 ▶️";
           } else {
               display.innerText = "目前在第 " + step + " 題";
               btn.innerText = "下一題 ➡️";
           }
       });

        // 核心邏輯：計算誰選了最多「少數派」
        window.calculateWinner = async () => {
            const snapshot = await get(ref(db, 'votes'));
            const allVotes = snapshot.val(); // 格式： { 題號: { 名字: {choice: 'A'} } }
            let userMinorityCount = {};

            for (let qIdx in allVotes) {
                let votes = allVotes[qIdx];
                let countA = 0, countB = 0;
                for (let name in votes) {
                    if (votes[name].choice === 'A') countA++; else countB++;
                }

                let minorityChoice = countA < countB ? 'A' : (countB < countA ? 'B' : null);
                
                if (minorityChoice) {
                    for (let name in votes) {
                        if (votes[name].choice === minorityChoice) {
                            userMinorityCount[name] = (userMinorityCount[name] || 0) + 1;
                        }
                    }
                }
            }

            // 找出最大值
            let winner = Object.keys(userMinorityCount).reduce((a, b) => userMinorityCount[a] > userMinorityCount[b] ? a : b);
            document.getElementById('result-display').innerHTML = `
                <h1 class="winner-anim">邊緣之神：${winner}</h1>
                <p>共選了 ${userMinorityCount[winner]} 次少數選項！</p>
            `;
        };
    </script>
</body>
</html>