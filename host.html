<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿå·¥å¤§åŠ‡å ´ - èª°æ˜¯æ€ªå’–ç‹</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #171615; color: #fff; text-align: center; font-family: sans-serif; }
        .control-panel { background: #28276d; padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 600px; }
        .q-display { background: #ebcf9f; padding: 15px; border-radius: 10px; margin: 20px 0; min-height: 100px; color: #333; position: relative; }
        .btn-main { background: #2da551; color: white; border: none; padding: 15px 30px; font-size: 1.5rem; border-radius: 10px; cursor: pointer; margin: 10px; }
        .btn-sub { background: #6d7175; color: white; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 8px; cursor: pointer; }
        .btn-calc { background: #ffc107; color: black; border: none; padding: 15px 30px; font-size: 1.5rem; border-radius: 10px; cursor: pointer; margin: 10px; font-weight: bold; display: none; }
        #winner-box { background: #df2b2b; color: #f7efe1; padding: 20px; border-radius: 15px; display: none; margin-top: 20px; animation: pulse 2s infinite; }
        /* äººæ•¸çµ±è¨ˆæµ®å‹•æ¨™ç±¤ */
        #live-counter { background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 10px; display: inline-block; color: #00ffcc; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <h1>ç”Ÿå·¥å¤§åŠ‡å ´ - èª°æ˜¯æ€ªå’–ç‹</h1>

    <div class="control-panel">
        <div id="live-counter">è¼‰å…¥ä¸­...</div>

        <div class="q-display">
            <h3 id="current-round" style="color: #4a4b94;"></h3>
            <h1 id="current-q"></h1>
            <p id="options-hint" style="color: #423d3d; font-weight: bold; font-size: 1.2rem;"></p>
        </div>

        <div id="winner-box">
            <h2 id="result-title"> æ­æ›‰çµæœ </h2>
            <div id="winner-name" style="font-size: 1.5rem;">---</div>
        </div>

        <hr style="border: 0.5px solid #444; margin: 20px 0;">
        
        <button onclick="showMinority()" id="minority-btn" class="btn-calc" style="display:none; background: #007bff; color: white;">ğŸ“Š æ­æ›‰æœ¬é¡Œå°‘æ•¸æ´¾</button>
        
        <button onclick="triggerWinner()" id="calc-btn" class="btn-calc">ğŸ† çµ±è¨ˆèª°æ˜¯æ€ªå’–ç‹</button>
        
        <br>
        <button onclick="nextStep()" id="next-btn" class="btn-main">é–‹å§‹éŠæˆ² â–¶ï¸</button>
        <br>
        <button onclick="prevStep()" class="btn-sub">â¬…ï¸ å›ä¸Šä¸€é¡Œ</button>

        <br><br>
        <button onclick="resetGame()" style="background: #444; color: #888; border: none; padding: 5px 10px; font-size: 0.7rem; cursor: pointer; border-radius: 5px;">
            å±éšªå€åŸŸï¼šé‡ç½®æ•´å€‹éŠæˆ²æ•¸æ“š
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyB9utfozRJXaMj07hOCMrEKB_s1wKVfbFw",
            authDomain: "bse-weirdoking.firebaseapp.com",
            projectId: "bse-weirdoking",
            storageBucket: "bse-weirdoking.firebasestorage.app",
            messagingSenderId: "154551508057",
            appId: "1:154551508057:web:47b1be7e7d76743788a548",
            measurementId: "G-WL3E8V5H94",
            databaseURL: "https://bse-weirdoking-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let step = 0;
        const questions = [
            { r: "æº–å‚™ä¸­...", q: "è«‹è¼¸å…¥åå­—", a: "", b: "" },
            { r: "ç¬¬ä¸€è¼ª (1/8)", q: "åƒä¸åƒé¦™èœï¼Ÿ", a: "åƒ", b: "ä¸åƒ" },
            { r: "ç¬¬ä¸€è¼ª (2/8)", q: "æ»·è‚‰é£¯æ‹Œä¸æ‹Œï¼Ÿ", a: "æ‹Œ", b: "ä¸æ‹Œ" },
            { r: "ç¬¬ä¸€è¼ª (3/8)", q: "å’–å“©æ‹Œä¸æ‹Œï¼Ÿ", a: "æ‹Œ", b: "ä¸æ‹Œ" },
            { r: "ç¬¬ä¸€è¼ª (4/8)", q: "ç«é‹èŠ‹é ­åŠ ä¸åŠ ï¼Ÿ", a: "åŠ ", b: "ä¸åŠ " },
            { r: "ç¬¬ä¸€è¼ª (5/8)", q: "å…¨ç³–æ‰‹æ–å–ä¸å–ï¼Ÿ", a: "å–", b: "ä¸å–" },
            { r: "ç¬¬ä¸€è¼ª (6/8)", q: "å¥¶èŒ¶ç¨®é¡ï¼Ÿ", a: "å¥¶ç²¾å¥¶èŒ¶", b: "é®®å¥¶èŒ¶" },
            { r: "ç¬¬ä¸€è¼ª (7/8)", q: "åœ°ç„é£Ÿæï¼Ÿ", a: "ä¸‰è‰²è±†", b: "è¢å…‰å’–å“©" },
            { r: "ç¬¬ä¸€è¼ª (8/8)", q: "çµå¥‡ç«é‹ï¼Ÿ", a: "è¶Šå—é´¨ä»”è›‹", b: "è±¬è…¦ç«é‹" },
            { r: "ä¼‘æ¯ä¸€ä¸‹æ²’æœ‰é€²å»£å‘Š", q: "èª°æ˜¯ç›®å‰çš„æ€ªå’–ï¼Ÿ", a: "", b: "" }, // 9
            { r: "ç¬¬äºŒè¼ª", q: "å“ªç¨®æ¯”è¼ƒå¥½å‘¢ï¼Ÿ", a: "å®‰éœè™•å¿…æ”¾å¤§å±", b: "ä¸€è¼©å­æ‹¿åŸºæœ¬å·¥è³‡" },
            { r: "ç¬¬äºŒè¼ª", q: "å¤–å‹èˆ‡æ°£å‘³ï¼Ÿ", a: "è¶…å¥½çœ‹ä½†æ¥µè‡­", b: "é†œä½†è‡ªå¸¶é¦™å‘³" },
            { r: "ç¬¬äºŒè¼ª", q: "äººç”ŸèƒŒæ™¯éŸ³ï¼Ÿ", a: "å°·å°¬æ™‚æœ‰æ‚²æƒ…é‹¼ç´", b: "å¤±æ•—æ™‚æœ‰ç½é ­ç¬‘è²" },
            { r: "ç¬¬äºŒè¼ª", q: "æˆ¿é–“ç¼ºé™·ï¼Ÿ", a: "é–€é—œä¸èµ·ä¾†", b: "çª—æˆ¶å¡ä½åŠé–‹" },
            { r: "ç¬¬äºŒè¼ª", q: "ç°¡å ±é…·åˆ‘ï¼Ÿ", a: "åœ–ç‰‡æª”ä¸”é…è‰²é›£çœ‹", b: "ä¸çµ¦èª²å¾Œæª”æ¡ˆ" },
            { r: "ç¬¬äºŒè¼ª", q: "é­”é¬¼èª²ç¨‹ï¼Ÿ", a: "PUAç’°å¢ƒå·¥ç¨‹", b: "ç•¶æ‰ä¸€åŠçš„æµé«”åŠ›å­¸" },
            { r: "ç¬¬äºŒè¼ª", q: "ä¸Šèª²åœ°ç„ï¼Ÿ", a: "åè¶…è‡­åŒå­¸æ—é‚Š", b: "æ•™æˆæ¯å ‚å¿…æŠ½å•" },
            { r: "ç¬¬äºŒè¼ª", q: "é«˜æº«æŒ‘æˆ°ï¼Ÿ", a: "é£²æ°´æ©Ÿåªæœ‰43åº¦æ°´", b: "å†·æ°£å£æ‰ä¸Šä¸‰å°æ™‚èª²" },
            { r: "æœ€çµ‚çµç®—", q: "ç©¶æ¥µæ€ªå’–ç‹ï¼Ÿï¼", a: "", b: "" } // 18
        ];

        // åŠŸèƒ½ 1 & 2: ç›£è½å ±åèˆ‡æŠ•ç¥¨äººæ•¸
        onValue(ref(db), (snapshot) => {
            const data = snapshot.val();
            const players = data?.players ? Object.keys(data.players).length : 0;
            const votes = (data?.votes && data.votes[step]) ? Object.keys(data.votes[step]).length : 0;
            
            if (step === 0) {
                document.getElementById('live-counter').innerText = `ğŸ“¢ ç›®å‰å ±åäººæ•¸ï¼š${players} äºº`;
            } else if (questions[step].a !== "") {
                document.getElementById('live-counter').innerText = `âœ… æœ¬é¡ŒæŠ•ç¥¨é€²åº¦ï¼š${votes} / ${players} äºº`;
            } else {
                document.getElementById('live-counter').innerText = `éŠæˆ²é€²è¡Œä¸­`;
            }
        });

        // åŠŸèƒ½ 3: æ­æ›‰æœ¬é¡Œå°‘æ•¸æ´¾
        window.showMinority = async () => {
            const snap = await get(ref(db, `votes/${step}`));
            const winnerBox = document.getElementById('winner-box');
            const winnerName = document.getElementById('winner-name');
            winnerBox.style.display = "block";
            
            if (!snap.exists()) {
                winnerName.innerText = "æ²’äººæŠ•ç¥¨è€¶...";
                return;
            }

            const votes = snap.val();
            let countA = 0, countB = 0;
            for (let p in votes) {
                if (votes[p].choice === 'A') countA++; else countB++;
            }

            let resultText = "";
            if (countA === countB) {
                resultText = `å¹³æ‰‹ï¼(A: ${countA} vs B: ${countB})`;
            } else {
                const minority = countA < countB ? 'A' : 'B';
                const minorityText = minority === 'A' ? questions[step].a : questions[step].b;
                resultText = `å°‘æ•¸æ´¾æ˜¯ï¼šã€${minorityText}ã€‘<br>(A: ${countA} ç¥¨ | B: ${countB} ç¥¨)`;
            }
            winnerName.innerHTML = resultText;
            document.getElementById('minority-btn').style.display = "none";
            document.getElementById('next-btn').style.display = "inline-block";
        };

        async function getWinner(untilStep) {
            const snapshot = await get(ref(db, 'votes'));
            if (!snapshot.exists()) return { name: "ç„¡æ•¸æ“š", history: "" };

            const allVotes = snapshot.val();
            let userMinorityCount = {};
            let stepResults = {}; // ç”¨ä¾†å­˜æ¯ä¸€é¡Œçš„å°‘æ•¸æ´¾é¸é …æ˜¯ä»€éº¼

            // 1. è¨ˆç®—æ¯å€‹äººé¸äº†å¹¾æ¬¡å°‘æ•¸ï¼Œä¸¦è¨˜éŒ„æ¯ä¸€é¡Œçš„å°‘æ•¸æ´¾é¸é …
            for (let i = 1; i <= untilStep; i++) {
                if (!allVotes[i]) continue;
                let votes = allVotes[i];
                let countA = 0, countB = 0;
                for (let name in votes) {
                    if (votes[name].choice === 'A') countA++; else countB++;
                }
                
                let minorityChoice = countA < countB ? 'A' : (countB < countA ? 'B' : null);
                stepResults[i] = minorityChoice; // è¨˜éŒ„ç¬¬ i é¡Œçš„å°‘æ•¸æ´¾æ˜¯ A é‚„æ˜¯ B
        
                if (minorityChoice) {
                    for (let name in votes) {
                        if (votes[name].choice === minorityChoice) {
                            userMinorityCount[name] = (userMinorityCount[name] || 0) + 1;
                        }
                    }
                }
            }
        
            if (Object.keys(userMinorityCount).length === 0) return { name: "å¤§å®¶éƒ½å¾ˆæ­£å¸¸", history: "" };
        
            // 2. æ‰¾å‡ºæœ€é«˜æ¬¡æ•¸èˆ‡ç²å‹è€…
            let maxCount = Math.max(...Object.values(userMinorityCount));
            let winners = Object.keys(userMinorityCount).filter(name => userMinorityCount[name] === maxCount);
        
            // 3. å»ºç«‹é¡¯ç¤ºæ¸…å–® (åªåˆ—å‡ºä»–å€‘é¸çš„ã€Œå°‘æ•¸é¸é …ã€)
            let         historyHtml = "<div style='font-size: 1rem; text-align: left; margin-top: 15px; border-top: 1px dashed #333; padding-top: 10px;'>";
            historyHtml += `<b>æ€ªå’–äº‹è¹Ÿç´€éŒ„ï¼š</b><br>`;
        
            winners.forEach(name => {
                historyHtml += `<p style="margin: 10px 0 5px 0; color: #df2b2b; font-weight: bold;">ã€${name}ã€‘çš„æ€ªå’–æ™‚åˆ»ï¼š</p>`;
                let foundAny = false;
                for (let i = 1; i <= untilStep; i++) {
                    // å¦‚æœé€™é¡Œè©²ç©å®¶é¸çš„å‰›å¥½æ˜¯è©²é¡Œçš„å°‘æ•¸æ´¾
                    if (allVotes[i] && allVotes[i][name] && allVotes[i][name].choice === stepResults[i]) {
                        let choiceText = (stepResults[i] === 'A') ? questions[i].a : questions[i].b;
                        historyHtml += `<span style="font-size: 0.9rem;">ğŸ“ ç¬¬${i}é¡Œï¼š${choiceText}</span><br>`;
                        foundAny = true;
                    }
                }
                if (!foundAny) historyHtml += `<span>ç„¡ (å¯èƒ½æ˜¯å¹³æ‰‹é€ æˆ)</span><br>`;
            });
            historyHtml += "</div>";
        
            // 4. å›å‚³é¡¯ç¤ºæ–‡å­—
            let displayName = winners.length > 1 
                ? `ä¸¦åˆ—æ€ªå’–ç‹ï¼š<br>${winners.join(" & ")}` 
                : `${winners[0]}`;
        
            return { 
                name: `${displayName}<br><small>(é¸äº† ${maxCount} æ¬¡å°‘æ•¸é¸é …)</small>`, 
                history: historyHtml 
            };
        }

        window.triggerWinner = async () => {
            const winnerBox = document.getElementById('winner-box');
            const winnerName = document.getElementById('winner-name');
            winnerBox.style.display = "block";
            winnerName.innerHTML = "è¨ˆç®—ä¸­...";
            let res = (step === 9) ? await getWinner(8) : await getWinner(17);
            winnerName.innerHTML = `<span style="font-size: 1.8rem;">${res.name}</span>${res.history}`;
        };

        window.nextStep = () => { 
            if (step < questions.length - 1) {
                step++;
                set(ref(db, 'gameState/currentStep'), step);
            }
        };
        
        window.prevStep = () => { 
            if (step > 0) {
                step--;
                set(ref(db, 'gameState/currentStep'), step);
            }
        };

        onValue(ref(db, 'gameState/currentStep'), (snap) => {
            step = snap.val() || 0;
            const q = questions[step];
            document.getElementById('current-round').innerText = q.r;
            document.getElementById('current-q').innerText = q.q;
            document.getElementById('options-hint').innerText = q.a ? `A: ${q.a}  vs  B: ${q.b}` : "";
            
            const nextBtn = document.getElementById('next-btn');
            const minorityBtn = document.getElementById('minority-btn');
            const calcBtn = document.getElementById('calc-btn');
            const winnerBox = document.getElementById('winner-box');

            winnerBox.style.display = "none";

            // åˆ¤æ–·æŒ‰éˆ•é¡¯ç¤ºé‚è¼¯
            if (step === 0) {
                // å ±åéšæ®µ
                nextBtn.style.display = "inline-block";
                nextBtn.innerText = "æ­£å¼é–‹å§‹éŠæˆ² â–¶ï¸";
                minorityBtn.style.display = "none";
                calcBtn.style.display = "none";
            } 
            else if (step === 9 || step === 18) {
                // ä¸­å ´çµ±è¨ˆæˆ–æœ€å¾Œçµç®—
                nextBtn.style.display = "inline-block";
                nextBtn.innerText = (step === 9) ? "é€²å…¥ç¬¬äºŒè¼ª â¡ï¸" : "éŠæˆ²çµæŸ";
                minorityBtn.style.display = "none";
                calcBtn.style.display = "inline-block";
            } 
            else {
                // ä¸€èˆ¬é¡Œç›®é é¢ï¼šéš±è—ã€Œä¸‹ä¸€é¡Œã€ï¼Œå…ˆé¡¯ç¤ºã€Œæ­æ›‰å°‘æ•¸æ´¾ã€
                nextBtn.style.display = "none"; 
                nextBtn.innerText = "ä¸‹ä¸€é¡Œ â¡ï¸"; // é è¨­å¥½æ–‡å­—ï¼Œç­‰æ­æ›‰å®Œé¡¯ç¤º
                minorityBtn.style.display = "inline-block";
                calcBtn.style.display = "none";
            }
        });

        // ä¿®æ”¹æ­æ›‰å‡½å¼ï¼Œç¢ºä¿æ­æ›‰å¾ŒæŒ‰éˆ•æ–‡å­—æ­£ç¢º
        window.showMinority = async () => {
            const snap = await get(ref(db, `votes/${step}`));
            const winnerBox = document.getElementById('winner-box');
            const winnerName = document.getElementById('winner-name');
            winnerBox.style.display = "block";
            
            if (!snap.exists()) {
                winnerName.innerText = "ç›®å‰æ²’æœ‰äººæŠ•ç¥¨å–”ï¼";
            } else {
                const votes = snap.val();
                let countA = 0, countB = 0;
                for (let p in votes) {
                    if (votes[p].choice === 'A') countA++; else countB++;
                }

                if (countA === countB) {
                    winnerName.innerHTML = `å¹³æ‰‹ï¼<br>(A: ${countA} ç¥¨ | B: ${countB} ç¥¨)`;
                } else {
                    const minority = countA < countB ? 'A' : 'B';
                    const minorityText = minority === 'A' ? questions[step].a : questions[step].b;
                    winnerName.innerHTML = `<span style="color:#fff">æœ¬é¡Œå°‘æ•¸æ´¾æ˜¯ï¼š</span><br>ã€${minorityText}ã€‘<br><small>(A: ${countA} vs B: ${countB})</small>`;
                }
            }
            
            // æ­æ›‰å®Œå¾Œï¼Œéš±æ­æ›‰æŒ‰éˆ•ï¼Œé¡¯ç¤ºã€Œä¸‹ä¸€é¡Œã€
            document.getElementById('minority-btn').style.display = "none";
            const nextBtn = document.getElementById('next-btn');
            nextBtn.style.display = "inline-block";
            // é€™è£¡ç¢ºä¿æ–‡å­—æ˜¯ä¸‹ä¸€é¡Œï¼Œé™¤éæ˜¯ç¬¬ 8 é¡Œè¦é€²ä¸­å ´
            if (step === 8) {
                nextBtn.innerText = "å‰å¾€ä¸­å ´çµç®— â¡ï¸";
            } else if (step === 17) {
                nextBtn.innerText = "å‰å¾€æœ€çµ‚çµç®— â¡ï¸";
            } else {
                nextBtn.innerText = "ä¸‹ä¸€é¡Œ â¡ï¸";
            }
        };

        window.resetGame = async () => {
            if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼ˆå«å ±åäººæ•¸ï¼‰å—ï¼Ÿ")) {
                await set(ref(db, 'gameState/currentStep'), 0);
                await set(ref(db, 'votes'), null); 
                await set(ref(db, 'players'), null); 
                location.reload();
            }
        };
    </script>
</body>
</html>