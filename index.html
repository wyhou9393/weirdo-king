<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™šæœƒå¤§å†’éšª - ç©å®¶</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        <h2 id="round-title">è¼‰å…¥ä¸­...</h2>
        <p id="question-text">è«‹ç­‰å¾…ä¸»æŒäººé–‹å§‹éŠæˆ²</p>

        <p id="count-display" style="font-size: 0.9rem; color: #ffeb3b; font-weight: bold;"></p>

        <div id="user-info-section">
            <div id="input-group">
                <input type="text" id="username" placeholder="è«‹è¼¸å…¥ä½ çš„åå­—">
                <button id="join-btn" onclick="confirmJoin()">ç¢ºèªå ±å</button>
                <p id="hint-text" style="font-size: 0.8rem; color: #eee; margin-top: 5px;">é»æ“ŠæŒ‰éˆ•é–å®šåç¨±</p>
            </div>
            <h2 id="welcome-msg" style="display: none;"></h2>
        </div>

        <div id="button-area" style="display:none;">
            <button onclick="vote('A')" id="btnA">é¸é … A</button>
            <button onclick="vote('B')" id="btnB">é¸é … B</button>
        </div>

        <p id="status-msg"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyB9utfozRJXaMj07hOCMrEKB_s1wKVfbFw",
            authDomain: "bse-weirdoking.firebaseapp.com",
            projectId: "bse-weirdoking",
            storageBucket: "bse-weirdoking.firebasestorage.app",
            messagingSenderId: "154551508057",
            appId: "1:154551508057:web:47b1be7e7d76743788a548",
            measurementId: "G-WL3E8V5H94",
            databaseURL: "https://bse-weirdoking-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentStep = 0;
        let playerName = ""; // å„²å­˜ç©å®¶åç¨±
        
        const questions = [
            { r: "éŠæˆ²æº–å‚™ä¸­", q: " ", a: "ç­‰å¾…é–‹å§‹", b: "ç­‰å¾…é–‹å§‹" },
            { r: "ç¬¬ä¸€è¼ª (1/8)", q: "ä½ åƒä¸åƒé¦™èœï¼Ÿ", a: "æš´åƒ", b: "æ­»éƒ½ä¸åƒ" },
            { r: "ç¬¬ä¸€è¼ª (2/8)", q: "æ»·è‚‰é£¯è¦æ‹Œå—ï¼Ÿ", a: "æ‹Œçˆ›", b: "è‚¯å®šä¸æ‹Œ" },
            { r: "ç¬¬ä¸€è¼ª (3/8)", q: "åƒå’–å“©æ‹Œä¸æ‹Œï¼Ÿ", a: "ç‹‚æ‹Œ", b: "ä¸å¯èƒ½æ‹Œ" },
            { r: "ç¬¬ä¸€è¼ª (4/8)", q: "åƒç«é‹æœƒåŠ èŠ‹é ­å—ï¼Ÿ", a: "ä¸€å®šåŠ ", b: "çµ•å°ä¸åŠ " },
            { r: "ç¬¬ä¸€è¼ª (5/8)", q: "å…¨ç³–æ‰‹æ–å–ä¸å–ï¼Ÿ", a: "ç‹‚å–çŒ›å–", b: "æœ‰å¤ ç”œ ä¸å¯èƒ½å–" },
            { r: "ç¬¬ä¸€è¼ª (6/8)", q: "å¸ƒä¸è¦æ€éº¼åƒï¼Ÿ", a: "æ”ªçˆ› æš´é¢¨å¸å…¥", b: "ç”¨æ¹¯åŒ™ä¸€å£ä¸€å£æ…¢æ…¢åƒ" },
            { r: "ç¬¬ä¸€è¼ª (7/8)", q: "æ¯”è¼ƒå–œæ­¡å“ªç¨®å¥¶èŒ¶ï¼Ÿ", a: "å¥¶ç²¾å¥¶èŒ¶", b: "é®®å¥¶èŒ¶" },
            { r: "ç¬¬ä¸€è¼ª (8/8)", q: "æ¡¶é¤åœ°ç„...å“ªå€‹å¥½ï¼Ÿ", a: "ä¸‰è‰²è±†", b: "è¢å…‰å’–å“©" },
            { r: "ä¸­å ´ä¼‘æ¯", q: "èª°æ˜¯ç›®å‰çš„æ€ªå’–...", a: "çµ±è¨ˆä¸­", b: "çµ±è¨ˆä¸­" },
            { r: "ç¬¬äºŒè¼ª (1/8)", q: "ä½ æœƒé¸æ“‡ï¼Ÿ", a: "é€²åœ–æ›¸é¤¨è·Ÿé›»æ¢¯ä¸€å®šæ”¾å¤§å±", b: "æ¯æ¬¡éƒ½æœƒé€²éŒ¯åæ»¿äººçš„æ•™å®¤" },
            { r: "ç¬¬äºŒè¼ª (2/8)", q: "åˆ†çµ„å ±å‘Šæƒ³è¦æŠ½åˆ°ï¼Ÿ", a: "å…¨ç¨‹å·²è®€ä¸å›çš„çµ„å“¡", b: "è¶…ç©æ¥µä½†è¶…ç¬¨çš„çµ„å“¡" },
            { r: "ç¬¬äºŒè¼ª (3/8)", q: "æ•™å®¤çš„è¨­å‚™ä½ èƒ½æ¥å—...ï¼Ÿ", a: "æŠ•å½±å¹•ç³Šåˆ°åƒæ‰“äº†ç¢¼", b: "éº¥å…‹é¢¨ç˜‹ç‹‚æš´éŸ³" },
            { r: "ç¬¬äºŒè¼ª (4/8)", q: "ä½ æƒ³è¦ä½ æ¯å¤©ä¸Šèª²çš„æ•™å®¤ï¼Ÿ", a: "é–€é–‹é—œéƒ½è¶…å¤§è²", b: "ç»ç’ƒçª—æˆ¶å¡ä½åªèƒ½åŠé–‹" },
            { r: "ç¬¬äºŒè¼ª (5/8)", q: "æƒ³è¦å“ªä¸€ç¨®èª²æœ¬ï¼Ÿ", a: "ç´…åº•é»ƒå­—(å·²ç)ä½†æ€è·¯æ¸…æ™°", b: "ç™½åº•é»‘å­—ä½†ä¸€å¤§å †å»¢è©±" },
            { r: "ç¬¬äºŒè¼ª (6/8)", q: "å“ªä¸€å ‚èª²æ¯”è¼ƒå¥½ï¼Ÿ", a: "è€å¸«ä¸Šèª²ç˜‹ç‹‚PUAä½ ", b: "è‡³å°‘ç•¶æ‰ä¸€åŠå­¸ç”Ÿçš„èª²" },
            { r: "ç¬¬äºŒè¼ª (7/8)", q: "æ•™å®¤åªå‰©ä¸€å€‹åº§ä½ï¼Œä½ æƒ³è¦...", a: "åè¶…è‡­åŒå­¸æ—é‚Š", b: "å…©é‚ŠåŒå­¸éš”è‘—ä½ ä¸€ç›´èŠå¤©" },
            { r: "ç¬¬äºŒè¼ª (8/8)", q: "å¤§ç†±å¤©ä½ èƒ½æ¥å—...ï¼Ÿ", a: "æ•´å¤©åªæœ‰43åº¦çš„æ°´å¯ä»¥å–", b: "å†·æ°£å£æ‰ä¸Šä¸‰å°æ™‚èª²" },
            { r: "éŠæˆ²çµæŸ", q: "èª°æ˜¯è¶…ç´šæ€ªå’–ç‹ï¼Ÿ", a: "çœ‹å¤§è¢å¹•", b: "çœ‹å¤§è¢å¹•" }
        ];

        // åŠŸèƒ½ 1ï¼šç¢ºèªå ±å
        window.confirmJoin = function() {
            playerName = document.getElementById('username').value.trim();
            if (!playerName) return alert("è«‹è¼¸å…¥åå­—å†å ±åå–”ï¼");

            // åœ¨è³‡æ–™åº«ç´€éŒ„ç©å®¶å·²åŠ å…¥
            set(ref(db, `players/${playerName}`), true);

            document.getElementById('input-group').style.display = "none";
            const welcomeMsg = document.getElementById('welcome-msg');
            welcomeMsg.innerText = `${playerName}`;
            welcomeMsg.style.display = "block";
            document.getElementById('status-msg').innerText = "å ±åæˆåŠŸï¼ç­‰å¾…éŠæˆ²é–‹å§‹...";
        };

        // ç›£è½å ±åäººæ•¸èˆ‡æŠ•ç¥¨äººæ•¸
        onValue(ref(db), (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            // 1. å…ˆå¾ Firebase æ‹¿åˆ°æœ€æ–°çš„ currentStepï¼Œå¦å‰‡æœƒæŠ“åˆ°èˆŠçš„
            const currentStep = data.gameState ? data.gameState.currentStep : 0;
            const isRevealed = data.gameState ? data.gameState.showResult : false; 
            const allVotes = data.votes || {};
            const q = questions[currentStep];
    
            const statusMsg = document.getElementById('status-msg');
            const countDisplay = document.getElementById('count-display');
            const welcomeMsg = document.getElementById('welcome-msg');
            const isAlreadyJoined = welcomeMsg.style.display === "block";

            // 2. è™•ç†ä¸­å ´ä¼‘æ¯èˆ‡éŠæˆ²çµæŸ
            if (q.r === "ä¸­å ´ä¼‘æ¯" || q.r === "éŠæˆ²çµæŸ") {
                document.getElementById('button-area').style.display = "none";
                document.getElementById('game-container').style.backgroundColor = "#d7c79f";
        
                let userMinorityCount = {};
                for (let i = 1; i <= currentStep; i++) {
                    let stepVotes = allVotes[i];
                    if (!stepVotes) continue;
                    let cA = 0, cB = 0;
                    for (let name in stepVotes) {
                        if (stepVotes[name].choice === 'A') cA++; else cB++;
                    }
                    let minority = cA < cB ? 'A' : (cB < cA ? 'B' : null);
                    if (minority) {
                        for (let name in stepVotes) {
                        if (stepVotes[name].choice === minority) {
                        userMinorityCount[name] = (userMinorityCount[name] || 0) + 1;
                    }
                }
            }
        }

        let winners = Object.entries(userMinorityCount).sort((a, b) => b[1] - a[1]);
        if (winners.length > 0) {
            let topScore = winners[0][1];
            let topNames = winners.filter(w => w[1] === topScore).map(w => w[0]).join(", ");
            statusMsg.innerHTML = `<span style="color:#d32f2f; font-weight:bold;">ğŸ† æ€ªå’–ç‹ï¼š${topNames}</span><br>` +
                                 (playerName && userMinorityCount[playerName] ? 
                                 `ä½ ç›®å‰ç´¯è¨ˆï¼š${userMinorityCount[playerName]} æ¬¡å°‘æ•¸æ´¾` : `ä½ ç›®å‰æ˜¯å¤§çœ¾è‡‰`);
        } else {
            statusMsg.innerText = "å¤§å®¶éƒ½å¾ˆæ­£å¸¸ï¼";
        }
    } 
    // 3. è™•ç†ä¸€èˆ¬é¡Œç›®
    else if (currentStep > 0) {
        document.getElementById('game-container').style.background = "";
        document.getElementById('button-area').style.display = "block";
        document.getElementById('input-group').style.display = "none";
        
        // æ›´æ–°æŒ‰éˆ•æ–‡å­—
        document.getElementById('btnA').innerText = q.a;
        document.getElementById('btnB').innerText = q.b;

        const thisStepVotes = allVotes[currentStep] || {};
        const myVoteData = thisStepVotes[playerName];
        
        if (myVoteData) {
            document.getElementById('btnA').disabled = true;
            document.getElementById('btnB').disabled = true;
            document.getElementById('btnA').classList.toggle('selected', myVoteData.choice === 'A');
            document.getElementById('btnB').classList.toggle('selected', myVoteData.choice === 'B');

            if (isRevealed) {
                let countA = 0, countB = 0;
                for (let name in thisStepVotes) {
                    if (thisStepVotes[name].choice === 'A') countA++; else countB++;
                }
                let minorityChoice = countA < countB ? 'A' : (countB < countA ? 'B' : null);

                if (minorityChoice === null) {
                    statusMsg.innerText = `æœ€çµ‚çµæœï¼šå¹³æ‰‹ (${countA}:${countB})`;
                } else if (myVoteData.choice === minorityChoice) {
                    statusMsg.innerHTML = `<span style="color:#ff5252; font-weight:bold; font-size:1.2rem;">æ­æ›‰ï¼šä½ æ˜¯å°‘æ•¸æ´¾ï¼ğŸ˜±</span><br>(æ¯”æ•¸ ${countA}:${countB})`;
                } else {
                    statusMsg.innerHTML = `<span style="color:#4caf50; font-weight:bold;">æ­æ›‰ï¼šä½ æ˜¯å¤šæ•¸æ´¾ï¼ğŸ‘</span><br>(æ¯”æ•¸ ${countA}:${countB})`;
                }
            } else {
                statusMsg.innerText = "æŠ•ç¥¨æˆåŠŸï¼è«‹ç­‰å¾…ä¸»æŒäººæ­æ›‰...";
            }
        } else {
            document.getElementById('btnA').disabled = false;
                    document.getElementById('btnB').disabled = false;
                    document.getElementById('btnA').classList.remove('selected');
                    document.getElementById('btnB').classList.remove('selected');
                    statusMsg.innerText = "è«‹é¸æ“‡ä½ çš„ç«‹å ´ï¼";
                }
            } 
            // 4. éŠæˆ²æº–å‚™éšæ®µ (Step 0)
            else {
                if (!isAlreadyJoined) document.getElementById('input-group').style.display = "block";
                document.getElementById('button-area').style.display = "none";
                statusMsg.innerText = "ç­‰å¾…ä¸»æŒäººé–‹å§‹...";
            }
        }); // é€™è£¡é—œé–‰ onValue
        
        onValue(ref(db, 'gameState/currentStep'), (snapshot) => {
            currentStep = snapshot.val() || 0;
            const q = questions[currentStep];

            document.getElementById('round-title').innerText = q.r;
            document.getElementById('question-text').innerText = q.q;

            const isAlreadyJoined = document.getElementById('welcome-msg').style.display === "block";

            // åŠŸèƒ½ 4ï¼šä¸­å ´ä¼‘æ¯è·Ÿçµç®—éš±è—æŒ‰éˆ•
            if (q.r === "ä¸­å ´ä¼‘æ¯" || q.r === "éŠæˆ²çµæŸ") {
                document.getElementById('button-area').style.display = "none";
                document.getElementById('game-container').style.backgroundColor = "#d7c79f";
                document.getElementById('status-msg').innerText = "çœ‹å¤§è¢å¹•æ­æ›‰ï¼";
            } else {
                document.getElementById('game-container').style.background = "";
                if (currentStep === 0) {
                    document.getElementById('button-area').style.display = "none";
                    if (!isAlreadyJoined) document.getElementById('input-group').style.display = "block";
                } else {
                    document.getElementById('input-group').style.display = "none";
                    document.getElementById('button-area').style.display = "block";
                    document.getElementById('btnA').innerText = q.a;
                    document.getElementById('btnB').innerText = q.b;
                    
                    // æ¯æ›æ–°çš„ä¸€é¡Œï¼Œé‡ç½®æŒ‰éˆ•ç‹€æ…‹
                    document.getElementById('btnA').disabled = false;
                    document.getElementById('btnB').disabled = false;
                    document.getElementById('btnA').classList.remove('selected');
                    document.getElementById('btnB').classList.remove('selected');
                    document.getElementById('status-msg').innerText = "è«‹é¸æ“‡ï¼";
                }
            }
        });

        // åŠŸèƒ½ 3ï¼šé–å®šæŒ‰éˆ•ä¸å¯åæ‚”
        window.vote = function(choice) {
            if (!playerName) return alert("è«‹å…ˆè¼¸å…¥åå­—å ±åï¼");

            update(ref(db, `votes/${currentStep}/${playerName}`), { choice: choice });
            
            // è¦–è¦ºæ•ˆæœ
            document.getElementById('btnA').classList.remove('selected');
            document.getElementById('btnB').classList.remove('selected');
            document.getElementById(choice === 'A' ? 'btnA' : 'btnB').classList.add('selected');
            
            // é–å®šæŒ‰éˆ•
            document.getElementById('btnA').disabled = true;
            document.getElementById('btnB').disabled = true;
            document.getElementById('status-msg').innerText = "æŠ•ç¥¨æˆåŠŸï¼Œä¸å¯ä»¥åæ‚”ï¼";
        };
    </script>
</body>
</html>