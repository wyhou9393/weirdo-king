<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>晚會大冒險 - 玩家</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        <h2 id="round-title">載入中...</h2>
        <p id="question-text">請等待主持人開始遊戲</p>

        <p id="count-display" style="font-size: 0.9rem; color: #ffeb3b; font-weight: bold;"></p>

        <div id="user-info-section">
            <div id="input-group">
                <input type="text" id="username" placeholder="請輸入你的名字">
                <button id="join-btn" onclick="confirmJoin()">確認報名</button>
                <p id="hint-text" style="font-size: 0.8rem; color: #eee; margin-top: 5px;">點擊按鈕鎖定名稱</p>
            </div>
            <h2 id="welcome-msg" style="display: none;"></h2>
        </div>

        <div id="button-area" style="display:none;">
            <button onclick="vote('A')" id="btnA">選項 A</button>
            <button onclick="vote('B')" id="btnB">選項 B</button>
        </div>

        <p id="status-msg"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyB9utfozRJXaMj07hOCMrEKB_s1wKVfbFw",
            authDomain: "bse-weirdoking.firebaseapp.com",
            projectId: "bse-weirdoking",
            storageBucket: "bse-weirdoking.firebasestorage.app",
            messagingSenderId: "154551508057",
            appId: "1:154551508057:web:47b1be7e7d76743788a548",
            measurementId: "G-WL3E8V5H94",
            databaseURL: "https://bse-weirdoking-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentStep = 0;
        let playerName = ""; // 儲存玩家名稱
        
        const questions = [
            { r: "遊戲準備中", q: " ", a: "等待開始", b: "等待開始" },
            { r: "第一輪 (1/8)", q: "吃不吃香菜？", a: "吃", b: "不吃" },
            { r: "第一輪 (2/8)", q: "滷肉飯拌不拌？", a: "拌", b: "不拌" },
            { r: "第一輪 (3/8)", q: "咖哩拌不拌？", a: "拌", b: "不拌" },
            { r: "第一輪 (4/8)", q: "火鍋芋頭加不加？", a: "加", b: "不加" },
            { r: "第一輪 (5/8)", q: "全糖手搖喝不喝？", a: "喝", b: "不喝" },
            { r: "第一輪 (6/8)", q: "奶茶種類？", a: "奶精奶茶", b: "鮮奶茶" },
            { r: "第一輪 (7/8)", q: "地獄食材？", a: "三色豆", b: "螢光咖哩" },
            { r: "第一輪 (8/8)", q: "獵奇火鍋？", a: "越南鴨仔蛋", b: "豬腦火鍋" },
            { r: "中場休息", q: "誰是目前的怪咖...", a: "統計中", b: "統計中" },
            { r: "第二輪", q: "哪種比較好呢？", a: "安靜處必放大屁", b: "一輩子拿基本工資" },
            { r: "第二輪", q: "外型與氣味？", a: "超好看但極臭", b: "醜但自帶香味" },
            { r: "第二輪", q: "人生背景音？", a: "尷尬時有悲情鋼琴", b: "失敗時有罐頭笑聲" },
            { r: "第二輪", q: "房間缺陷？", a: "門關不起來", b: "窗戶卡住半開" },
            { r: "第二輪", q: "簡報酷刑？", a: "圖片檔且配色難看", b: "不給課後檔案" },
            { r: "第二輪", q: "魔鬼課程？", a: "PUA環境工程", b: "當掉一半的流體力學" },
            { r: "第二輪", q: "上課地獄？", a: "坐超臭同學旁邊", b: "教授每堂必抽問" },
            { r: "第二輪", q: "高溫挑戰？", a: "飲水機只有43度水", b: "冷氣壞掉上三小時課" },
            { r: "遊戲結束", q: "誰是究極怪咖王？", a: "看大螢幕", b: "看大螢幕" }
        ];

        // 功能 1：確認報名
        window.confirmJoin = function() {
            playerName = document.getElementById('username').value.trim();
            if (!playerName) return alert("請輸入名字再報名喔！");

            // 在資料庫紀錄玩家已加入
            set(ref(db, `players/${playerName}`), true);

            document.getElementById('input-group').style.display = "none";
            const welcomeMsg = document.getElementById('welcome-msg');
            welcomeMsg.innerText = `${playerName}`;
            welcomeMsg.style.display = "block";
            document.getElementById('status-msg').innerText = "報名成功！等待遊戲開始...";
        };

        // 監聽報名人數與投票人數
        onValue(ref(db), (snapshot) => {
            const data = snapshot.val();
            if(!data) return;

            const players = data.players ? Object.keys(data.players).length : 0;
            const votes = (data.votes && data.votes[currentStep]) ? Object.keys(data.votes[currentStep]).length : 0;
            const countDisplay = document.getElementById('count-display');

            if (currentStep === 0) {
                countDisplay.innerText = "";
            } else if (questions[currentStep].r !== "中場休息" && questions[currentStep].r !== "遊戲結束") {
                countDisplay.innerText = "";
            } else {
                countDisplay.innerText = "";
            }
        });
        
        onValue(ref(db, 'gameState/currentStep'), (snapshot) => {
            currentStep = snapshot.val() || 0;
            const q = questions[currentStep];

            document.getElementById('round-title').innerText = q.r;
            document.getElementById('question-text').innerText = q.q;

            const isAlreadyJoined = document.getElementById('welcome-msg').style.display === "block";

            // 功能 4：中場休息跟結算隱藏按鈕
            if (q.r === "中場休息" || q.r === "遊戲結束") {
                document.getElementById('button-area').style.display = "none";
                document.getElementById('game-container').style.background = "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)";
                document.getElementById('status-msg').innerText = "看大螢幕揭曉！";
            } else {
                document.getElementById('game-container').style.background = "";
                if (currentStep === 0) {
                    document.getElementById('button-area').style.display = "none";
                    if (!isAlreadyJoined) document.getElementById('input-group').style.display = "block";
                } else {
                    document.getElementById('input-group').style.display = "none";
                    document.getElementById('button-area').style.display = "block";
                    document.getElementById('btnA').innerText = q.a;
                    document.getElementById('btnB').innerText = q.b;
                    
                    // 每換新的一題，重置按鈕狀態
                    document.getElementById('btnA').disabled = false;
                    document.getElementById('btnB').disabled = false;
                    document.getElementById('btnA').classList.remove('selected');
                    document.getElementById('btnB').classList.remove('selected');
                    document.getElementById('status-msg').innerText = "請選擇！";
                }
            }
        });

        // 功能 3：鎖定按鈕不可反悔
        window.vote = function(choice) {
            if (!playerName) return alert("請先輸入名字報名！");

            update(ref(db, `votes/${currentStep}/${playerName}`), { choice: choice });
            
            // 視覺效果
            document.getElementById('btnA').classList.remove('selected');
            document.getElementById('btnB').classList.remove('selected');
            document.getElementById(choice === 'A' ? 'btnA' : 'btnB').classList.add('selected');
            
            // 鎖定按鈕
            document.getElementById('btnA').disabled = true;
            document.getElementById('btnB').disabled = true;
            document.getElementById('status-msg').innerText = "投票成功，不可以反悔！";
        };
    </script>
</body>
</html>